{% extends "sidebar-base.html" %}

{% block title %}
Minutes of Meetings - Roopvilla Project
{% endblock %}

{% block morestyles %}
<link href="static/css/moms.css" rel="stylesheet">
{% endblock %}

{% block panel %}
<div class="container">
    <div class="d-flex align-items-center p-3 my-3 text-white bg-purple rounded shadow-sm">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-journals mx-2" viewBox="0 0 16 16">
            <path d="M5 0h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2 2 2 0 0 1-2 2H3a2 2 0 0 1-2-2h1a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1H1a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v9a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1H3a2 2 0 0 1 2-2z"/>
            <path d="M1 6v-.5a.5.5 0 0 1 1 0V6h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V9h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 2.5v.5H.5a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1H2v-.5a.5.5 0 0 0-1 0z"/>
          </svg>
      <div class="lh-1">
        <h1 class="h6 mb-0 text-white lh-1">Minutes of Meetings</h1>
        <small>Since 2022</small>
      </div>
      <div class="btn-group mx-3">
        <button type="button" class="btn btn-success" onclick="showOnly('#createMom');">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-journal-plus" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 5.5a.5.5 0 0 1 .5.5v1.5H10a.5.5 0 0 1 0 1H8.5V10a.5.5 0 0 1-1 0V8.5H6a.5.5 0 0 1 0-1h1.5V6a.5.5 0 0 1 .5-.5z"/>
                <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2z"/>
                <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1z"/>
              </svg>
            Create
        </button>
        <button type="button" class="btn btn-danger" onclick="showOnly('#deleteMom');">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-journal-x" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M6.146 6.146a.5.5 0 0 1 .708 0L8 7.293l1.146-1.147a.5.5 0 1 1 .708.708L8.707 8l1.147 1.146a.5.5 0 0 1-.708.708L8 8.707 6.854 9.854a.5.5 0 0 1-.708-.708L7.293 8 6.146 6.854a.5.5 0 0 1 0-.708z"/>
                <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2z"/>
                <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1z"/>
              </svg>
            Delete
        </button>
      </div>
    </div>
    <div class="m-auto-1 text-center" >
        <span id="message">Hello there</span>
    </div>
</div>
<div id='createMom' class="selectable bg-dark-green p-3 rounded-3">
    <form id="createMomForm">
        <div class="input-group" style="width: 20%;">
            <span class="input-group-text">Creation Date</span>
            <input type="date" class="form-control" name='createDate' required>
        </div>
        <div style="width: 100%;" class="my-2">
            <span>Put your minutes in the form of<code class="ms-2">"Topic::Decision"</code></span>
            <div class="input-group mb-3">
                <textarea class="form-control" id="minutes" rows="3"></textarea>
                <button class="btn btn-primary" type="button" onclick="AddMom();">Add</button>
            </div>
        </div>
        Added Estimates will show up in this table:
            <table class="table table-dark table-striped table-sm">
                <thead>
                    <tr>
                        <th scope="col">Topic</th>
                        <th scope="col">Decision</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="momList">
                </tbody>
            </table>
            <button class="btn btn-primary my-2" type="submit">Create Munites of the Meeting</button>
    </form>
</div>
<div id='deleteMom' class="selectable bg-dark-green p-3 rounded-3">
    Under Construction
</div>

<script>
    $(function(){
        $(".selectable").hide();
        $("#message").hide();

        //Create Mom Submit
        $("#createMomForm").submit(function(event){
            event.preventDefault();
            const data = $(this).serializeArray();
            let formData = {}
            data.forEach((element)=>{
                formData[element.name]=element.value;
            });
            if(!momMap.size)
            {
                return;
            }
            const reqData={
                date:new Date(formData.createDate).toUTCString(),
                moms: Array.from(momMap.values())
            }
            console.log(reqData);
            APICall("POST", `/moms`,reqData, (data)=>{
                this.reset();
                momMap.clear();
                displayMOMTable()
            }, true );
        });
    })

    function showOnly(id){
        $(".selectable").hide();
        $(id).show(500);
    }

    let momMap= new Map();
    function AddMom(){
        if(!$("#minutes").val()){
        return;
        }
        const now = Date.now();
        let momData=$("#minutes").val().split('::');
        const data={
            topic:momData[0],
            decision:momData[1] === undefined ? "None" : momData[1]
        }

        momMap.set(now.toString(), data);
        //reset
        $("#minutes").val("");
        displayMOMTable();
    }


    function displayMOMTable(){
        let target=$("#momList").html("");

        momMap.forEach((value, key)=>{
            const template=`<tr>
            <td class="text-truncate">
                <span class="d-inline-block text-truncate" style="max-width: 250px;">
                    ${value.topic}
                </span></td>
            <td class="text-truncate">
                <span class="d-inline-block text-truncate" style="max-width: 250px;">
                    ${value.decision}
                </span></td>
            <td>
                <div class="btn-group" role="group" aria-label="Basic example">
                    <button type="button" class="btn btn-warning btn-sm" value=${key} onclick="editMom(this.value);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-fill" viewBox="0 0 16 16">
                        <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/>
                    </svg>
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" value=${key} onclick="deleteMom(this.value);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                    </button>
                </div>
            </td>
            </tr>
            `;
            target.append(template);
        });
  }
  function deleteMom(id){
    momMap.delete(id);
    displayMOMTable()
  }
  function editMom(id){
    let data = momMap.get(id);
    const value= data.topic+"::"+data.decision;
    $("#minutes").val(value);
    momMap.delete(id);
    displayMOMTable();
  }

  
  function APICall(method, url, data, callback, refreshData){
    showLoading()
    const successCodes=[200,201];
    const client = new XMLHttpRequest();
    client.onload = function (){
        if (successCodes.includes(this.status)) {
          displayMssage(true,undefined);
          if(callback){
            callback(JSON.parse(this.responseText));
          }
          if(refreshData){}
        }
        else if(this.status === 204){
          displayMssage(true,undefined);
          if(callback){
            callback();
          }
          if(refreshData){}
        }
        else{
          try{
            let response=JSON.parse(this.responseText)
            console.log(response);
            displayMssage(false,response.error);
          }
          catch(err){
            displayMssage(false,undefined);
          }
        }
    }
    client.open(method,url,true);
    if(data){
      client.setRequestHeader("Content-type","application/json");
      client.send(JSON.stringify(data));
    }
    else{
      client.send();
    }
    
  }

  function displayMssage(is_success,message){
    if(is_success){
      $("#message").html(`<b>${message? message : "Successfully Updated!"}</b><br>`);
      $("#message").css("color","green");
    }
    else{
      $("#message").html(`<b>${message? message : "Couldn't Update!"}</b><br>`);
      $("#message").css("color","red");
    }

    $("#message").fadeTo(2000, 1).slideUp(1500, function() {
      $("#message").hide();
    });
  }
  function showLoading()
  {
    $("#message").css("color","white");
    $("#message").html(`<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>Loading...`);
    $("#message").fadeTo(100, 0.4);
  }

</script>


{% endblock %}


{% block morescripts %}
{% endblock %}